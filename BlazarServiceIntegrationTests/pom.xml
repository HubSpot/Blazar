<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>com.hubspot</groupId>
    <artifactId>Blazar</artifactId>
    <version>1.0-SNAPSHOT</version>
  </parent>

  <artifactId>BlazarServiceIntegrationTests</artifactId>

  <properties>
    <blazar-mysql.password>test123</blazar-mysql.password>
  </properties>

  <dependencies>
    <dependency>
      <groupId>com.hubspot</groupId>
      <artifactId>BlazarBase</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>com.google.guava</groupId>
      <artifactId>guava</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>com.google.inject</groupId>
      <artifactId>guice</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.jukito</groupId>
      <artifactId>jukito</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-install-plugin</artifactId>
        <configuration>
          <skip>true</skip>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-deploy-plugin</artifactId>
        <configuration>
          <skip>true</skip>
        </configuration>
      </plugin>
    </plugins>
  </build>

  <profiles>
    <profile>
      <id>run-docker-integration-tests</id>
      <activation>
        <property>
          <name>env.DOCKER_HOST</name>
        </property>
      </activation>
      <properties>
        <mesos.slave1.hostname>blazar-test-slave1</mesos.slave1.hostname>
        <mesos.master.hostname>blazar-test-master</mesos.master.hostname>
      </properties>
      <build>
        <plugins>
          <plugin>
            <artifactId>maven-failsafe-plugin</artifactId>
            <executions>
              <execution>
                <id>integration-test</id>
                <goals>
                  <goal>integration-test</goal>
                </goals>
              </execution>
              <execution>
                <id>verify</id>
                <goals>
                  <goal>verify</goal>
                </goals>
              </execution>
            </executions>
            <configuration>
              <systemPropertyVariables>
                <!-- Needs to be repeated here (the following two lines strangely doesn't work when the next line is omitted although)
                     Maven, you little sneaky beast ... -->
                <zk.port>${zk.port}</zk.port>
                <mesos.master.port>${mesos.master.port}</mesos.master.port>
                <mesos.slave1.port>${mesos.slave.1.port}</mesos.slave1.port>
                <singularity.port>${singularity.port}</singularity.port>
                <blazar.port>${blazar.port}</blazar.port>
              </systemPropertyVariables>
            </configuration>
          </plugin>
          <plugin>
            <groupId>org.jolokia</groupId>
            <artifactId>docker-maven-plugin</artifactId>
            <configuration>
              <images>
                <image>
                  <name>bobrik/zookeeper</name>
                  <alias>blazar-test-zk</alias>
                  <run>
                    <namingStrategy>alias</namingStrategy>
                    <ports>
                      <port>zk.port:2181</port>
                    </ports>
                    <env>
                      <ZK_CONFIG>tickTime=2000,initLimit=10,syncLimit=5,maxClientCnxns=128,forceSync=no,clientPort=2181</ZK_CONFIG>
                      <ZK_ID>1</ZK_ID>
                    </env>
                  </run>
                </image>
                <image>
                  <name>mesosphere/mesos-master:${mesos.docker.tag}</name>
                  <alias>blazar-test-master</alias>
                  <run>
                    <namingStrategy>alias</namingStrategy>
                    <links>
                      <link>blazar-test-zk</link>
                    </links>
                    <ports>
                      <port>mesos.master.port:5050</port>
                    </ports>
                    <env>
                      <MESOS_ZK>zk://blazar-test-zk:2181/mesos</MESOS_ZK>
                      <MESOS_QUORUM>1</MESOS_QUORUM>
                      <MESOS_CLUSTER>blazar-integration-test</MESOS_CLUSTER>
                      <MESOS_WORK_DIR>/var/lib/mesos</MESOS_WORK_DIR>
                      <MESOS_HOSTNAME>${mesos.master.hostname}</MESOS_HOSTNAME>
                    </env>
                    <wait>
                      <log>Elected as the leading master</log>
                      <time>10000</time>
                    </wait>
                  </run>
                </image>
                <image>
                  <name>hubspot/singularityexecutorslave:latest</name>
                  <alias>blazar-test-slave1</alias>
                  <run>
                    <namingStrategy>alias</namingStrategy>
                    <privileged>true</privileged>
                    <links>
                      <link>blazar-test-zk</link>
                      <link>blazar-test-master</link>
                    </links>
                    <ports>
                      <port>mesos.slave1.port:5051</port>
                    </ports>
                    <env>
                      <MESOS_MASTER>zk://blazar-test-zk:2181/mesos</MESOS_MASTER>
                      <MESOS_CONTAINERIZERS>docker,mesos</MESOS_CONTAINERIZERS>
                      <MESOS_HOSTNAME>${mesos.slave1.hostname}</MESOS_HOSTNAME>
                      <MESOS_PORT>5051</MESOS_PORT>
                    </env>
                    <volumes>
                      <bind>
                        <volume>/var/run/docker.sock:/var/run/docker.sock</volume>
                        <volume>/sys:/sys</volume>
                      </bind>
                    </volumes>
                    <wait>
                      <log>Registered with master</log>
                      <time>10000</time>
                    </wait>
                  </run>
                </image>
                <image>
                  <name>hubspot/singularityservice:${singularity.version}</name>
                  <alias>blazar-test-singularity</alias>
                  <run>
                    <namingStrategy>alias</namingStrategy>
                    <links>
                      <link>blazar-test-zk</link>
                      <link>blazar-test-master</link>
                      <link>blazar-test-slave1</link>
                    </links>
                    <ports>
                      <port>singularity.port:7099</port>
                    </ports>
                    <env>
                      <SINGULARITY_MESOS_MASTER>zk://blazar-test-zk:2181/mesos</SINGULARITY_MESOS_MASTER>
                      <SINGULARITY_ZK>blazar-test-zk:2181</SINGULARITY_ZK>
                      <SINGULARITY_URI_BASE>/singularity</SINGULARITY_URI_BASE>
                      <SINGULARITY_PORT>7099</SINGULARITY_PORT>
                    </env>
                    <wait>
                      <log>SingularityStartup: Finished startup</log>
                      <time>10000</time>
                    </wait>
                  </run>
                </image>
                <image>
                  <name>mysql:5.5</name>
                  <alias>blazar-test-mysql</alias>
                  <run>
                    <ports>
                      <port>blazar-mysql.port:3306</port>
                    </ports>
                    <env>
                      <MYSQL_ROOT_PASSWORD>${blazar-mysql.password}</MYSQL_ROOT_PASSWORD>
                      <MYSQL_DATABASE>Blazar</MYSQL_DATABASE>
                    </env>
                  </run>
                </image>
                <image>
                  <name>hubspot/blazarservice:${project.version}</name>
                  <alias>blazar-service</alias>
                  <run>
                    <namingStrategy>alias</namingStrategy>
                    <links>
                      <link>blazar-test-zk</link>
                      <link>blazar-test-mysql</link>
                      <link>blazar-test-singularity</link>
                    </links>
                    <ports>
                      <port>blazar.port:7199</port>
                    </ports>
                    <env>
                      <BLAZAR_ZK>blazar-test-zk:2181</BLAZAR_ZK>
                      <BLAZAR_MYSQL_HOST>blazar-test-mysql</BLAZAR_MYSQL_HOST>
                      <BLAZAR_MYSQL_USER>root</BLAZAR_MYSQL_USER>
                      <BLAZAR_MYSQL_PASSWORD>${blazar-mysql.password}</BLAZAR_MYSQL_PASSWORD>
                      <BLAZAR_PORT>7199</BLAZAR_PORT>
                      <BLAZAR_DB_MIGRATIONS>/etc/blazar/schema.sql</BLAZAR_DB_MIGRATIONS>
                    </env>
                    <!--wait>
                      <log>Started BlazarService</log>
                      <time>10000</time>
                    </wait-->
                  </run>
                </image>
              </images>
            </configuration>
            <!-- Connect this plugin to the maven lifecycle around the integration-test phase. I.e. start the container
                 in pre-integration-test and stop it in post-integration-test. -->
            <executions>
              <execution>
                <id>start-docker-images</id>
                <phase>pre-integration-test</phase>
                <goals>
                  <goal>start</goal>
                </goals>
              </execution>
              <execution>
                <id>stop-docker-images</id>
                <phase>post-integration-test</phase>
                <goals>
                  <goal>stop</goal>
                </goals>
              </execution>
            </executions>
          </plugin>
        </plugins>

      </build>
    </profile>
  </profiles>
</project>
